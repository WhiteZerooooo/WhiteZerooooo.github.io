<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食之契约神器</title>
    <link rel="icon" type="image/x-icon" href="https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@2.1.5/assets/other/ico/goods-icon-880877.ico">

    <!-- 引入外部CSS和字体 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../html/0HeadAndNav.css">

    <style>
        /* 主要内容区域 */
        .main-container {
            max-width: 2200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* 控制面板样式 */
        .control-panel {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-label {
            font-weight: 500;
        }

        .select-control {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }

        .btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: #e05555;
        }

        .btn-edit {
            background-color: #4a7baf;
        }
        
        .btn-edit:hover {
            background-color: #3a6a9f;
        }
        
        .btn-save {
            background-color: #4caf50;
        }
        
        .btn-save:hover {
            background-color: #3d8b40;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* 截图容器样式 */
        .screenshot-container {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .screenshot-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        /* 表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .data-table th {
            background-color: #f4f4f4;
            padding: 0.75rem;
            text-align: left;
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* 颜色样式 */
        .color-蓝 {
            background-color: #99BEFF;
            color: #005eff;
            font-weight: bold;
            text-align: center;
        }

        .color-红 {
            background-color: #FFE9E8;
            color: #ff3b30;
            font-weight: bold;
            text-align: center;
        }

        .color-青 {
            background-color: #99DDFF;
            color: #00aaff;
            font-weight: bold;
            text-align: center;
        }

        .color-紫 {
            background-color: #D58EFF;
            color: #a200ff;
            font-weight: bold;
            text-align: center;
        }

        .color-绿 {
            background-color: #EEFCDE;
            color: #88ff00;
            font-weight: bold;
            text-align: center;
        }

        .color-黄 {
            background-color: #FEFBC6;
            color: #cdc300;
            font-weight: bold;
            text-align: center;
        }

        /* 差异高亮样式 */
        .diff-added {
            background-color: #a8f1a8;
        }

        .diff-removed {
            background-color: #f8d7da;
            text-decoration: line-through;
        }
        
        /* 编辑模式样式 */
        .editable {
            border: 1px dashed #ccc;
            padding: 0.5rem;
            min-height: 1.5rem;
            background-color: #f9f9f9;
        }
        
        .edit-mode .editable {
            border: 1px solid #4a7baf;
            background-color: #f0f7ff;
        }
        
        .edit-notice {
            text-align: center;
            color: #4a7baf;
            font-weight: bold;
            margin-bottom: 1rem;
            display: none;
        }
        
        .edit-mode .edit-notice {
            display: block;
        }

        /* 结果容器样式 */
        .result-container {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .result-title {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        /* 响应式设计 */
        @media screen and (max-width: 768px) {
            .control-panel {
                flex-direction: column;
            }
            
            .control-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .select-control {
                width: 100%;
            }
            
            .screenshot-title {
                font-size: 1.3rem;
            }
            
            /* 更紧凑的表格 */
            .data-table th, 
            .data-table td {
                padding: 0.3rem;
                font-size: 0.8rem;
            }
            
            /* 调整截图按钮位置 */
            #capture-btn {
                margin-top: 0.5rem;
                order: 99; /* 移到最后 */
            }
            
            /* 更小的复选框 */
            .checkbox-group {
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <!-- 页面头部 -->
    <header class="header">
        <img class="header-image"
            src="https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@2.1.5/assets/other/WebsiteTexture/head.jpg"
            alt="Header Image">
        <h1 class="header-title">缇尔菈秘档</h1>
    </header>

    <!-- 导航栏 - 修改为响应式 -->
    <nav class="navbar">
        <!-- 汉堡菜单按钮（移动端显示） -->
        <button class="hamburger" id="hamburger">
            <i class="bi bi-list"></i>
        </button>
        
        <!-- 导航列表 -->
        <ul class="nav-list" id="navList">
            <li class="nav-item"><a href="../html/StoryView.html" class="nav-link"><i class="bi bi-images"></i>缇尔菈展览馆</a></li>
            <li class="nav-item"><a href="../html/Tools.html" class="nav-link"><i class="bi bi-tools"></i>立绘查看工具</a></li>
            <li class="nav-item"><a href="../html/TwoDraw.html" class="nav-link"><i class="bi bi-heart-fill"></i>拉郎模拟器</a></li>
            <li class="nav-item"><a href="../html/CardDraw.html" class="nav-link"><i class="bi bi-hammer"></i>抽卡模拟器</a></li>
            <li class="nav-item"><a href="../html/TeamExcel.html" class="nav-link"><i class="bi bi-table"></i>飨灵组织表格</a></li>
            <li class="nav-item"><a href="https://wiki.biligame.com/szqy/首页" class="nav-link"><i class="bi bi-book"></i>食契WIKI</a></li>
            <li class="nav-item"><a href="../html/TeamMember.html" class="nav-link"><i class="bi bi-people-fill"></i>关于我们</a></li>
        </ul>
    </nav>

    <!-- 主要内容 -->
    <div class="main-container">
        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="control-group">
                <label for="select_card" class="control-label">请选择飨灵</label>
                <select id="select_card" class="select-control" onchange="handleSelectCard()"></select>
            </div>

            <div class="control-group">
                <label for="select_version" class="control-label">请选择版本</label>
                <select id="select_version" class="select-control" onchange="handleSelectVersion()"></select>
            </div>

            <button id="capture-btn" class="btn"><i class="bi bi-camera"></i>生成截图</button>

            <div class="checkbox-group">
                <input type="checkbox" id="myCheckbox" name="myCheckbox" value="1">
                <label for="myCheckbox">关闭差异</label>
            </div>
            
            <!-- 添加加密文本开关 -->
            <div class="checkbox-group">
                <input type="checkbox" id="encryptCheckbox" name="encryptCheckbox" value="1">
                <label for="encryptCheckbox">加密文本</label>
            </div>
            
            <button id="edit-btn" class="btn btn-edit"><i class="bi bi-pencil"></i>开启编辑</button>
            <button id="save-btn" class="btn btn-save" style="display:none"><i class="bi bi-check-lg"></i>保存编辑</button>
        </div>

        <!-- 截图容器 -->
        <div class="screenshot-container" id="screenshot-container">
            <div class="edit-notice">编辑模式已开启 - 点击文本区域进行编辑</div>
            <h1 class="screenshot-title" id="title"></h1>

            <table class="data-table" id="panel-table">
                <thead>
                    <tr>
                        <th>职业</th>
                        <th>堕神1</th>
                        <th>堕神2</th>
                        <th>攻击力</th>
                        <th>攻速值</th>
                        <th>防御力</th>
                        <th>生命值</th>
                        <th>暴击值</th>
                        <th>暴伤值</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>基础技</th>
                    </tr>
                </thead>
                <tbody id="base-skill-body"></tbody>
            </table>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>能量技</th>
                    </tr>
                </thead>
                <tbody id="energy-skill-body"></tbody>
            </table>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>连携技</th>
                    </tr>
                </thead>
                <tbody id="connect-skill-body"></tbody>
            </table>

            <table class="data-table" id="artifacts-table">
                <thead>
                    <tr>
                        <th>核心</th>
                        <th>描述</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 结果容器 -->
        <div class="result-container">
            <h3 class="result-title">生成的截图：</h3>
            <div id="screenshot-result" style="scale: 0.95;"></div>
        </div>
    </div>

    <script src="diff.js"></script>
    <script src="html2canvas.min.js"></script>

    <script>
        // 汉堡菜单点击事件
        document.getElementById('hamburger').addEventListener('click', function() {
            document.getElementById('navList').classList.toggle('active');
        });

        // 初始化复选框事件
        const checkbox = document.getElementById('myCheckbox');
        checkbox.addEventListener('change', function () {
            handleSelectVersion();
            updateEditButtonState();
        });

        // 初始化加密复选框事件
        const encryptCheckbox = document.getElementById('encryptCheckbox');
        encryptCheckbox.addEventListener('change', function () {
            handleSelectVersion();
        });

        // 更新编辑按钮状态
        function updateEditButtonState() {
            const editBtn = document.getElementById('edit-btn');
            if (checkBoxStatus()) {
                editBtn.disabled = false;
            } else {
                editBtn.disabled = true;
                // 如果不在编辑模式但差异已关闭，退出编辑模式
                if (isEditMode) {
                    exitEditMode();
                }
            }
        }

        // 退出编辑模式
        function exitEditMode() {
            isEditMode = false;
            document.getElementById('screenshot-container').classList.remove('edit-mode');
            document.getElementById('edit-btn').style.display = 'flex';
            document.getElementById('save-btn').style.display = 'none';
            makeContentNotEditable();
            handleSelectVersion(); // 刷新显示
        }

        // 编辑按钮事件
        const editBtn = document.getElementById('edit-btn');
        const saveBtn = document.getElementById('save-btn');
        let isEditMode = false;
        
        editBtn.addEventListener('click', function() {
            if (!checkBoxStatus()) return; // 只有在关闭差异模式下才能编辑
            
            isEditMode = true;
            document.getElementById('screenshot-container').classList.add('edit-mode');
            editBtn.style.display = 'none';
            saveBtn.style.display = 'flex';
            makeContentEditable();
        });
        
        saveBtn.addEventListener('click', function() {
            saveEditsToStorage();
            exitEditMode();
        });

        // 截图按钮事件
        document.getElementById('capture-btn').addEventListener('click', () => {
            const element = document.getElementById('screenshot-container');
            html2canvas(element, {
                useCORS: true,
                scale: 2,
                backgroundColor: null
            }).then(canvas => {
                const resultContainer = document.getElementById('screenshot-result');
                resultContainer.innerHTML = '';
                resultContainer.appendChild(canvas);
            }).catch(error => {
                console.error('截图失败:', error);
            });
        });

        // 使内容可编辑
        function makeContentEditable() {
            // 基础技、能量技、连携技
            document.querySelectorAll('#base-skill-body td, #energy-skill-body td, #connect-skill-body td').forEach(td => {
                td.contentEditable = true;
                td.classList.add('editable');
            });
            
            // 神器描述
            document.querySelectorAll('#artifacts-table td:nth-child(2)').forEach(td => {
                td.contentEditable = true;
                td.classList.add('editable');
            });
        }
        
        // 使内容不可编辑
        function makeContentNotEditable() {
            document.querySelectorAll('.editable').forEach(el => {
                el.contentEditable = false;
                el.classList.remove('editable');
            });
        }
        
        // 保存编辑内容到本地存储
        function saveEditsToStorage() {
            const select_card = document.getElementById("select_card");
            const select_version = document.getElementById("select_version");
            const selectedCard = select_card.options[parseInt(select_card.value)].text;
            const selectedVersion = select_version.options[parseInt(select_version.value)].text;
            
            if (!selectedCard || !selectedVersion) return;
            
            // 获取编辑的数据
            const editedData = {
                BaseSkill: document.querySelector('#base-skill-body td').innerText,
                EnergySkill: document.querySelector('#energy-skill-body td').innerText,
                ConnectSkill: document.querySelector('#connect-skill-body td').innerText,
                Artifacts: {}
            };
            
            // 获取神器编辑数据
            document.querySelectorAll('#artifacts-table tr').forEach(tr => {
                const th = tr.querySelector('th');
                if (th && th.innerText === '核心') return;
                const firstTd = tr.querySelector('td:first-child');
                const lastTd = tr.querySelector('td:last-child');
                if (firstTd && lastTd) {
                    const key = firstTd.innerText;
                    const value = lastTd.innerText;
                    editedData.Artifacts[key] = value;
                }
            });
            
            // 创建编辑版本名称
            const editedVersion = "编辑版";
            
            // 保存到localStorage
            const storageKey = `edited_${selectedCard}_${editedVersion}`;
            localStorage.setItem(storageKey, JSON.stringify(editedData));
            localStorage.setItem(`edited_${selectedCard}_newVersion`, selectedVersion);
            
            // 更新版本下拉框，添加编辑版本
            updateVersionDropdownWithEdit(selectedCard, editedVersion);
            
            // alert('编辑内容已保存为"' + editedVersion + '"版本！');
        }
        
        // 更新版本下拉框，包含编辑版本
        function updateVersionDropdownWithEdit(cardName, editedVersion) {
            const select_version = document.getElementById("select_version");
            
            // 检查是否已存在此编辑版本
            let exists = false;
            for (let i = 0; i < select_version.options.length; i++) {
                if (select_version.options[i].text === editedVersion) {
                    exists = true;
                    break;
                }
            }
            
            // 如果不存在，添加编辑版本
            if (!exists) {
                const option = document.createElement("option");
                option.value = select_version.options.length;
                option.text = editedVersion;
                select_version.appendChild(option);
            }
            
            // 选择编辑版本
            select_version.value = Array.from(select_version.options).findIndex(opt => opt.text === editedVersion);
            
            // 触发版本变更
            handleSelectVersion();
        }
        
        // 从本地存储获取编辑内容
        function getEditsFromStorage(card, version) {
            const storageKey = `edited_${card}_${version}`;
            const editedData = localStorage.getItem(storageKey);
            return editedData ? JSON.parse(editedData) : null;
        }
        
        // 检查是否有编辑内容
        function hasEdits(card, version) {
            const storageKey = `edited_${card}_${version}`;
            return localStorage.getItem(storageKey) !== null;
        }
        
        // 清除编辑内容
        function clearEdits(card, version) {
            const storageKey = `edited_${card}_${version}`;
            localStorage.removeItem(storageKey);
        }

        // 初始化差异比较
        var diffCH = new Diff.Diff();
        diffCH.tokenize = function (v) {
            return v.split(/([^\x00-\x7F×])|(<br>)/);
        }

        // 获取复选框状态
        function checkBoxStatus() {
            return document.getElementById('myCheckbox').checked;
        }
        
        // 获取加密复选框状态
        function encryptCheckBoxStatus() {
            return document.getElementById('encryptCheckbox').checked;
        }
        
        // 加密文本函数 - 保留数字，将其他字符替换为▇
        function encryptText(text) {
            if (!encryptCheckBoxStatus()) {
                return text;
            }
            
            return text.replace(/[^\d]/g, '▇');
        }

        // 生成差异高亮文本
        function getDiff(oldText, newText) {
            // 如果关闭差异，直接返回新文本
            if (checkBoxStatus()) {
                return encryptText(newText);
            }
            
            const_diff = diffCH.diff(oldText, newText);
            let const_change = "";

            const_diff.forEach(function (u) {
                if (u.added) {
                    const_change += `<span class="diff-added">${encryptText(u.value)}</span>`;
                } else if (u.removed) {
                    if (const_diff.length < 15) {
                        const_change += `<span class="diff-removed">${encryptText(u.value)}</span>`;
                    }
                } else {
                    if (const_diff.length > 1) {
                        const_change += encryptText(u.value);
                    }
                }
            });

            if (const_diff.length >= 15) {
                const_change = `<span class="diff-removed">${encryptText(oldText)}</span><br><span class="diff-added">${encryptText(newText)}</span>`;
            }

            if (oldText == newText) {
                const_change = encryptText(newText);
            }

            return const_change.replaceAll("colorstyle", "color style");
        }

        // 更新表格数据
        function updataTable(oldData, newData, editedData = null) {
            // 如果有编辑数据，使用编辑数据
            if (editedData) {
                newData = {
                    ...newData,
                    BaseSkill: editedData.BaseSkill,
                    EnergySkill: editedData.EnergySkill,
                    ConnectSkill: editedData.ConnectSkill,
                    Artifacts: {
                        ...newData.Artifacts,
                        Info: editedData.Artifacts
                    }
                };
            }

            // 更新面板表格
            function updatePanelTable(tableId, oldInfo, newInfo) {
                const tableBody = document.querySelector(`${tableId} tbody`);
                tableBody.innerHTML = `
                <tr>
                    <td>${getDiff(oldInfo["career"], newInfo["career"])}</td>
                    <td>${getDiff(oldInfo["pet1"], newInfo["pet1"])}</td>
                    <td>${getDiff(oldInfo["pet2"], newInfo["pet2"])}</td>
                    <td>${getDiff(oldInfo["attack"], newInfo["attack"])}</td>
                    <td>${getDiff(oldInfo["attackRate"], newInfo["attackRate"])}</td>
                    <td>${getDiff(oldInfo["defence"], newInfo["defence"])}</td>
                    <td>${getDiff(oldInfo["hp"], newInfo["hp"])}</td>
                    <td>${getDiff(oldInfo["critRate"], newInfo["critRate"])}</td>
                    <td>${getDiff(oldInfo["critDamage"], newInfo["critDamage"])}</td>
                </tr>
                `;
            }

            // 更新技能表格
            function updateSkillTable(tableId, oldSkills, newSkills) {
                const tableBody = document.querySelector(tableId);
                tableBody.innerHTML = `
                <tr>
                    <td>${getDiff(oldSkills, newSkills)}</td>
                </tr>
                `;
            }

            // 更新神器表格
            function updateArtifactTable(tableId, oldInfo, newInfo, colors) {
                const tableBody = document.querySelector(`${tableId} tbody`);
                tableBody.innerHTML = '';

                Object.keys(newInfo).forEach((key) => {
                    const colorKey = key.slice(-2, -1);
                    const colorName = colors[colorKey] || '未知';
                    tableBody.innerHTML += `
                        <tr>
                        <td class="color-${colorName}">${key}</td>
                        <td>${getDiff(oldInfo[key], newInfo[key])}</td>
                        </tr>
                    `;
                });
            }

            // 调用更新函数
            updatePanelTable('#panel-table', oldData.Panel, newData.Panel);
            updateSkillTable('#base-skill-body', oldData.BaseSkill, newData.BaseSkill);
            updateSkillTable('#energy-skill-body', oldData.EnergySkill, newData.EnergySkill);
            updateSkillTable('#connect-skill-body', oldData.ConnectSkill, newData.ConnectSkill);
            updateArtifactTable('#artifacts-table', oldData.Artifacts.Info, newData.Artifacts.Info, newData.Artifacts.Color);
        }

        // 更新飨灵选择下拉框
        function updataSelectCard(data) {
            const select_card = document.getElementById("select_card");
            select_card.innerHTML = '';

            Object.keys(data).forEach((key, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = key;
                select_card.appendChild(option);
            });

            handleSelectCard();
        }

        // 更新版本选择下拉框
        function updataSelectVersion(data) {
            const select_version = document.getElementById("select_version");
            select_version.innerHTML = '';

            Object.keys(data).forEach((key, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = key;
                select_version.appendChild(option);
            });

            // 添加所有编辑版本
            const selectedCard = document.getElementById("select_card").options[parseInt(document.getElementById("select_card").value)].text;
            addEditedVersionsToDropdown(selectedCard);
            
            select_version.selectedIndex = select_version.options.length - 1;
            handleSelectVersion();
        }
        
        // 添加编辑版本到下拉框
        function addEditedVersionsToDropdown(cardName) {
            const select_version = document.getElementById("select_version");
            
            // 获取所有以"(编辑)"结尾的本地存储键
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`edited_${cardName}_编辑版`)) {
                    const version = key.replace(`edited_${cardName}_`, "");
                    
                    // 检查是否已存在此版本
                    let exists = false;
                    for (let j = 0; j < select_version.options.length; j++) {
                        if (select_version.options[j].text === version) {
                            exists = true;
                            break;
                        }
                    }
                    
                    // 如果不存在，添加编辑版本
                    if (!exists) {
                        const option = document.createElement("option");
                        option.value = select_version.options.length;
                        option.text = version;
                        select_version.appendChild(option);
                    }
                }
            }
        }

        // 处理飨灵选择变化
        function handleSelectCard() {
            const select_card = document.getElementById("select_card");
            const selectedCard = select_card.options[parseInt(select_card.value)].text;

            if (globalData[selectedCard]) {
                updataSelectVersion(globalData[selectedCard]);
            }
            
            updateEditButtonState();
        }

        // 处理版本选择变化
        function handleSelectVersion() {
            const select_card = document.getElementById("select_card");
            const select_version = document.getElementById("select_version");
            const selectedCard = select_card.options[parseInt(select_card.value)].text;
            const selectedVersion = select_version.options[parseInt(select_version.value)].text;

            // 检查是否是编辑版本
            const isEditedVersion = selectedVersion.endsWith("编辑版");
            
            // 计算上一个版本
            let PreVersion = "";
            
            if (isEditedVersion) {
                // 对于编辑版本，比较基础是去掉"(编辑)"的原始版本
                const versions = Object.keys(globalData[selectedCard]);
                const latestVersion = versions[versions.length - 1];
                PreVersion = latestVersion
            } else {
                const versionNumber = parseInt(selectedVersion.replace("v", ""));
                if (versionNumber === 0) {
                    PreVersion = "v0";
                } else {
                    PreVersion = "v" + (versionNumber - 1);
                }
            }

            // 如果关闭差异，则使用相同版本
            if (checkBoxStatus() && !isEditedVersion) {
                PreVersion = selectedVersion;
            }

            // 检查是否有编辑内容
            let editedData = null;
            if (isEditedVersion) {
                editedData = getEditsFromStorage(selectedCard, selectedVersion);
            }

            // 更新标题和表格
            const name = isEditedVersion ? 
                globalData[selectedCard][Object.keys(globalData[selectedCard])[0]].Name : 
                globalData[selectedCard][PreVersion].Name;
                
            let versionText = selectedVersion === PreVersion ? selectedVersion : `${PreVersion} → ${selectedVersion}`;
            
            // 如果有编辑内容，在标题中显示
            // if (editedData) {
            //     versionText += " (已编辑)";
            // }
            
            document.getElementById('title').textContent = `${name} ${versionText}`;

            if (globalData[selectedCard][PreVersion] && globalData[selectedCard][selectedVersion]) {
                updataTable(globalData[selectedCard][PreVersion], globalData[selectedCard][selectedVersion], editedData);
            } else if (isEditedVersion && globalData[selectedCard][PreVersion]) {
                // 对于编辑版本，使用原始版本作为比较基准
                updataTable(globalData[selectedCard][PreVersion], globalData[selectedCard][PreVersion], editedData);
            }
            
            updateEditButtonState();
        }

        // 加载JSON数据
        let globalData;
        fetch(`Card_Arti&Skill_Data.json?t=${new Date().getTime()}`)
            .then(response => response.json())
            .then(data => {
                globalData = data;
                updataSelectCard(globalData);
                
                // 检查是否有需要清除的编辑数据（当最新版变更时）
                Object.keys(globalData).forEach(cardName => {
                    const versions = Object.keys(globalData[cardName]);
                    const latestVersion = versions[versions.length - 1];
                    const memVersion = localStorage.getItem(`edited_${cardName}_newVersion`);
                    console.log(`检查飨灵 ${cardName}：本地版本 ${memVersion}，最新版本 ${latestVersion}`);
                    if (latestVersion != memVersion) {
                        localStorage.setItem(`edited_${cardName}_newVersion`, latestVersion);
                    }
                    if (latestVersion != memVersion && hasEdits(cardName, "编辑版")) {
                        clearEdits(cardName, "编辑版");
                    }
                });
                
                updateEditButtonState();
            })
            .catch(error => console.error('加载JSON文件失败:', error));
    </script>
</body>

</html>
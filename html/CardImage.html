<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>零の立绘预览</title>
    <link rel="icon" type="image/x-icon" href="https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/assets/ico/image2.ico">
    <style>
    body,
    html {
        display: flex;
        justify-content: center;
    }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
</body>
<script>
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
var cardname = urlParams.get('name') || 200001;
var cardid = urlParams.get('id') || 200001;
var cardfind = ''
var CanStop = false
var cardtype = urlParams.get('type') || '';
fetch('https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/json/card.json')
    .then(response => response.json())
    .then(data => {
        // 遍历 JSON 数据，查找与提供的名称匹配的条目，并返回其 ID
        if (cardtype === 'SP' || cardtype === 'SP满破') { cardname = `${cardname}(SP)` };
        let name = `${cardname}`; // 你要查找的名称
        Object.values(data).forEach(item => {
            if (item.name === name) {
                cardid = item.id;
                cardfind += item.id;
                const cardTypeSuffix = {
                    '满破': '_5',
                    '1': '_7',
                    '2': '_8',
                    '花嫁': '_9',
                    '泳装': '_10',
                    '童话': '_11',
                    '春节': '_12',
                    '联动': '_20'
                };
                if (cardTypeSuffix.hasOwnProperty(cardtype)) { cardid += cardTypeSuffix[cardtype]; }
                const img1 = `https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/assets/card/card_draw_bg_${cardid}.jpg`;
                const img2 = `https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/assets/card/card_draw_${cardid}.png`;
                const img3 = `https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/assets/card/card_draw_fg_${cardid}.png`;
                var imagesLoaded = 3;
                var images = [];

                function loadImages() {
                    var imageSources = [img1, img2, img3];
                    var promises = [];
                    for (var i = 0; i < imageSources.length; i++) {
                        promises.push(checkFileExists(imageSources[i]));
                    }

                    Promise.all(promises)
                        .then(results => {
                            console.log(results);
                            for (var i = 0; i < results.length; i++) {
                                if (results[i]) {
                                    imageSources.push(imageSources[i]);
                                }
                            }
                            console.log(imageSources);
                            for (var i = 3; i < imageSources.length; i++) {
                                var image = new Image();
                                image.onload = function() {
                                    imagesLoaded++;
                                    if (imagesLoaded === imageSources.length) { createStackedImage(); }
                                };
                                image.src = imageSources[i];
                                images.push(image);
                            }
                        });
                }

                function createStackedImage() {
                    var maxWidth = 0;
                    var maxHeight = 0;
                    for (var i = 0; i < images.length; i++) {
                        maxWidth = Math.max(maxWidth, images[i].width);
                        maxHeight = Math.max(maxHeight, images[i].height);
                    }
                    var canvas = document.getElementById('canvas');
                    var context = canvas.getContext('2d');
                    canvas.width = maxWidth;
                    canvas.height = maxHeight;
                    var xOffset = (maxWidth - images[0].width) / 2;
                    var yOffset = (maxHeight - images[0].height) / 2;
                    for (var i = 0; i < images.length; i++) {
                        var image = images[i];
                        var x = (maxWidth - image.width) / 2;
                        var y = (maxHeight - image.height) / 2;
                        context.drawImage(image, x, y);
                    }
                }
                loadImages();
            } else if (name === "200001" && CanStop === false) {
                CanStop = true
                const cardTypeSuffix = {
                    '满破': '_5',
                    '1': '_7',
                    '2': '_8',
                    '花嫁': '_9',
                    '泳装': '_10',
                    '童话': '_11',
                    '春节': '_12',
                    '联动': '_20'
                };
                if (cardTypeSuffix.hasOwnProperty(cardtype)) { cardid += cardTypeSuffix[cardtype]; }
                const img1 = `https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/assets/card/card_draw_bg_${cardid}.jpg`;
                const img2 = `https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/assets/card/card_draw_${cardid}.png`;
                const img3 = `https://gcore.jsdelivr.net/gh/WhiteZerooooo/FoodFantasyResource@1.0.7/assets/card/card_draw_fg_${cardid}.png`;
                var imagesLoaded = 3;
                var images = [];

                function loadImages() {
                    var imageSources = [img1, img2, img3];
                    var promises = [];
                    for (var i = 0; i < imageSources.length; i++) {
                        promises.push(checkFileExists(imageSources[i]));
                    }

                    Promise.all(promises)
                        .then(results => {
                            console.log(results);
                            for (var i = 0; i < results.length; i++) {
                                if (results[i]) {
                                    imageSources.push(imageSources[i]);
                                }
                            }
                            console.log(imageSources);
                            for (var i = 3; i < imageSources.length; i++) {
                                var image = new Image();
                                image.onload = function() {
                                    imagesLoaded++;
                                    if (imagesLoaded === imageSources.length) { createStackedImage(); }
                                };
                                image.src = imageSources[i];
                                images.push(image);
                            }
                        });
                }

                function createStackedImage() {
                    var maxWidth = 0;
                    var maxHeight = 0;
                    for (var i = 0; i < images.length; i++) {
                        maxWidth = Math.max(maxWidth, images[i].width);
                        maxHeight = Math.max(maxHeight, images[i].height);
                    }
                    var canvas = document.getElementById('canvas');
                    var context = canvas.getContext('2d');
                    canvas.width = maxWidth;
                    canvas.height = maxHeight;
                    var xOffset = (maxWidth - images[0].width) / 2;
                    var yOffset = (maxHeight - images[0].height) / 2;
                    for (var i = 0; i < images.length; i++) {
                        var image = images[i];
                        var x = (maxWidth - image.width) / 2;
                        var y = (maxHeight - image.height) / 2;
                        context.drawImage(image, x, y);
                    }
                }
                loadImages();
            }
        });
    })

function checkFileExists(url) {
    return fetch(url)
        .then(response => {
            if (response.ok) {
                // 文件存在
                return response.text();
            } else {
                // 文件不存在
                throw new Error('文件不存在');
            }
        })
        .then(html => {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var titleElement = doc.querySelector('title');
            var titleText = titleElement ? titleElement.textContent.trim() : '';
            if (titleText === '404 Error') {
                return false;
            } else {
                return true;
            }
        })
        .catch(error => {
            // 请求发生错误
            console.error('请求发生错误:', error);
            return false;
        });
}

const canvas = document.getElementById('canvas');

canvas.addEventListener('touchstart', function() {
    // 创建一个链接元素
    const link = document.createElement('a');
    // 设置链接的下载属性和文件名
    link.download = 'image.png';
    // 将 Canvas 转换为图像数据 URL
    const dataUrl = canvas.toDataURL();
    // 设置链接的 href 属性为 Canvas 的数据 URL
    link.href = dataUrl;
    // 模拟点击链接进行下载
    link.click();
});
</script>

</html>